<!DOCTYPE html>
<html>
<head>
<title>Clean HTML</title>
<meta charset="UTF-8">
<link rel="stylesheet" href="styles.css">
<script src="jquery-3.3.1.min.js"></script>
<script src="tidy.js"></script>
<script>
$(function () {

    function nodeFilter () {

        // keep: element nodes and text nodes
        // remove: comments, fragments, namespaced elements
        return !(this.nodeType === 1 || this.nodeType === 3) || this.nodeName.match(/:/);

    }

    function whitespace () {

        return $.parseHTML(" ");

    }

    var whiteColor = $("<div></div>").css("color", "#fff").css("color");

    $("#convert").click(function () {

        $("#target").empty();

        $("#source").clone().contents().appendTo("#target");

        var p = $("#target");

        // if the entire source was wrapped in a single block, move everything up
        p.children("div:only-child, p:only-child").each(function () {

            $(this).replaceWith($(this).contents());

        });

        // remove nodes that aren't elements or text (e.g. comments)
        p.contents().filter(nodeFilter).remove();
        p.find("*").contents().filter(nodeFilter).remove();

        // remove embedded CSS
        p.find("style").remove();

        // remove white-coloured text
        p.find("*").filter(function () {

            return $(this).css("color") == whiteColor;

        }).replaceWith(whitespace);

        // remove blocks with nothing but whitespace inside
        p.find("div, p").filter(function () {

            return $(this).text().trim() == "";

        }).replaceWith(whitespace);

        // matched elements are removed from the tree, their children moved up to take their place
        p.find("font, a[name], span[lang], span[style], li > p, a u").each(function () {

            $(this).replaceWith($(this).contents());

        });

        // remove superfluous underlines around links
        p.find("u > a:only-child").parent().each(function () {

            $(this).replaceWith($(this).contents());

        });

        // merge sibling lists
        p.find("ul, ol").each(function () {

            if (($(this).is("ul") && $(this).prev().is("ul")) || ($(this).is("ol") && $(this).prev().is("ol"))) {

                $(this).prev().append($(this).children());
                $(this).remove();

            }

        });

        // remove unnecessary non-breaking spaces
        p.html(function (i, html) {

            return html.replace(/&nbsp;/g, " ");

        });

        // find inline elements that aren't so-called "void elements" and clean them up if they're empty or only contain whitespace
        p.find(":not(area,base,br,col,embed,hr,img,input,keygen,link,meta,param,source,track,wbr)").filter(function () {

            return $(this).css("display") == "inline";

        }).each(function () {

            if (this.innerHTML == "") {

                $(this).remove();

            } else if (this.innerHTML.trim() == "") {

                $(this).replaceWith(whitespace);

            } else if (this.innerHTML.match(/^[\u2000-\u206F\u2E00-\u2E7F\\'!"#$%&()*+,\-.\/:;<=>?@\[\]^_`{|}~ \f\n\r\t\v\u00a0\u1680\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]+$/)) {

                // replace inline elements that only contain punctuation and/or whitespace with their contents
                $(this).replaceWith($(this).contents());

            } else {

                // protect leading whitespace from tidy_html5 (trailing seems to be safe)
                if (this.innerHTML.match(/^\s/)) {

                    $(this).before(whitespace);

                }

            }

        });

        // replace headings with <div><strong>
        p.find("h1, h2, h3, h4, h5, h6").each(function () {

            var div = $("<div><strong></strong></div>");

            div.children().first().append($(this).contents());

            $(this).replaceWith(div);

        });

        // clear any remaining unwanted attributes
        p.find("[class]").removeAttr("class");
        p.find("[dir]").removeAttr("dir");
        p.find("[id]").removeAttr("id");
        p.find("[lang]").removeAttr("lang");
        p.find("[style]").removeAttr("style");

        // matched elements (at the top level only) get a spacer inserted after them
        p.children("div, p").each(function () {

            if (! $(this).next().is("ul, ol")
                && ! $(this).prev().is("ul, ol")
                && ! ($(this).children().is("b:only-child, strong:only-child, i:only-child, em:only-child") && $(this).children().text().trim() == $(this).text().trim())
                ) {

               $(this).after($("<div>&nbsp;</div>"))

            }

        });

        // specify target=_blank for all links (except mailto's)
        p.find("a").each(function () {

            if (!$(this).attr("href").match(/^mailto:/)) {

                $(this).attr("target", "_blank");

            } else {

                $(this).removeAttr("target");

            }

        });

        // matched elements are replaced with divs
        p.find("p").each(function () {

            $(this).replaceWith($("<div></div>").append($(this).contents()));

        });

        // swap out <b> and <i> with <strong> and <em>
        p.find("b").each(function () {

            $(this).replaceWith($("<strong></strong>").append($(this).contents()));

        });

        p.find("i").each(function () {

            $(this).replaceWith($("<em></em>").append($(this).contents()));

        });

        // see http://api.html-tidy.org/tidy/quickref_5.6.0.html
        var options = {
            "indent":               "auto",
            "indent-spaces":        2,
            "wrap":                 0,
            "break-before-br":      true,
            "clean":                false,
            "drop-empty-elements":  false,
            "drop-empty-paras":     false,
            "numeric-entities":     false,
            "preserve-entities":    true,
            "quote-marks":          true,
            "show-body-only":       true,
            "tidy-mark":            false
        };

        // tidy_html5 strips line breaks, which means whitespace can be lost, so enforce whitespace
        var output = tidy_html5(p.html().replace(/[\r\n]+/g, " "), options);

        // replace commonly-used "curly quotes" with their corresponding entities
        $("#output").val(output.replace(/\u201C/g, "&ldquo;").replace(/\u201D/g, "&rdquo;").replace(/\u2018/g, "&lsquo;").replace(/\u2019/g, "&rsquo;"));

    });

});
</script>
</head>
<body>
<div id="source" contenteditable="true"></div>
<div id="target" contenteditable="true"></div>
<textarea id="output"></textarea>
<button id="convert">Convert</button>
</body>
</html>
